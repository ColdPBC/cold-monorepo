<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://cold-public-assets.s3.us-east-2.amazonaws.com/Asset+4Logotype_Preferred.svg" width="699" alt="Cold Climate Logo" /></a>
</p>

  <p align="center">Monorepo for the Cold Climate Ecosystem</p>
    <p align="center"></p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description
✨ **This monorepo has been generated by [Nx, a Smart, fast and extensible build system.](https://nx.dev)** ✨
- [/apps/cold-ui](https://github.com/ColdPBC/cold-monorepo/tree/main/apps/cold-ui/README.md) - The Cold Climate Front-End React App.

- [/apps/cold-api](https://github.com/ColdPBC/cold-monorepo/tree/main/apps/cold-api/README.md) - The Cold Climate REST API

## Deployment Lifecycle
   coming soon

## Getting Started
- Make sure you've followed the instructions to set up your dev machine on [the Dev Setup Notion page](https://www.notion.so/coldclimate/Setting-Up-Your-Local-Environment-95c1f5398890412ab446d7ff94bcec7a?pvs=4), including Homebrew and Docker install
- install node 20.9.0:
  ```bash
    $ brew install node@20.9.0
  ```
- check yarn version 
    ```bash
    $ yarn -v
    ```
    if you receive an error like: ```zsh: command not found: yarn``` then you will need to install yarn globally
  - install latest yarn
    - install corepack globally
    ```bash
    $ yarn add global corepack
    ```
    - enable corepack
    ```bash
    $ corepack enable
    ```
    - set yarn version
    ```bash
    $ yarn set version latest
    ```
- install nestjs cli globally
  ```bash
  $ yarn add global @nestjs/cli 
  ````
- install prisma globally
  ```bash
  $ yarn add global prisma
  ```

### Environment Variables

Either create a .env file in the root directory of the project and populate the following variables. Or make sure they are stored in your IDE (Webstorm). You can get them from the Heroku staging server or ask Troy.

```dotenv
# General Settings
NODE_ENV=development
PORT=7001
API_SERVER_DESCRIPTION=The staging server is our development server
API_SERVER_URL=http://localhost:7001

# Auth0 Variables
AUTH0_AUDIENCE=https://api.coldclimate.online/
AUTH0_CLIENT_ID=UG9T########HQFI
AUTH0_CLIENT_SECRET=6r7D_6i########LoaIYb_
AUTH0_DOMAIN=cold-climate-staging.us.auth0.com
AUTH0_UI_CLIENT_ID=55HO8########SRWpG

# Database
DATABASE_URL="postgres://postgres:postgres@localhost/colddb"

# Redis Cache
REDISCLOUD_URL=redis://localhost:6379

```

### Install Node Dependencies

```bash
$ yarn
```

## Running NX Commands

To execute tasks with Nx use the following syntax:

```
nx <target> <project> <...options>
```

You can also run multiple targets:

```
nx run-many -t <target1> <target2>
```

..or add `-p` to filter specific projects

```
nx run-many -t <target1> <target2> -p <proj1> <proj2>
```

Targets can be defined in the `package.json` or `projects.json`. Learn more [in the docs](https://nx.dev/core-features/run-tasks).

## Integrations / Microservices
This mono-repo contains various microservices that facilitate the Cold Climate Ecosystem. Each microservice is located in the `/apps` directory and are build upon the NestJS framework.  Each microservice is a standalone application that can be run independently of the others.  However, they are designed to work together to provide a seamless experience for the user.

### Internal Services
All microservices communcate with each other via RabbitMQ.  This is made easier through the use of the [Shared NestJS Library](./libs/nest/README.md). This library provides a set of decorators that can be used to easily define the RabbitMQ configuration for each microservice.  However it is still necessary to define the RabbitMQ configuration for the microservice.  This is done by adding the rabbitMQ configuration to  a `definition` object in the service's `package.json` file.  Any configuration options that aren't managed by launch darkly should be placed here.  If configured correctly the microservice will register itself in the cold climate db so that other services will be able to discover it and since it contains the RabbitMQ configuration the consuming services will know how to communicate with it. 
```package.json
"definition": {
    "logo_url": "./assets/climatiq.png",
    "platform_url": "https://www.climatiq.io",
    "rabbitMQ": {
      "rpc": {
        "queue": "cold.platform.climatiq",
        "routing_key": "cold.platform.climatiq.rpc",
        "exchange": "amq.direct"
      },
      "subscribe": {
        "queue": "cold.platform.climatiq.rpc",
        "routing_key": "cold.platform.climatiq",
        "exchange": "amq.direct"
      }
    }
  }
```
### Customer Facing Integrations
Since some of our microservice facilitate integrations into 3rd party data sources for customer data, they typically require some configuration steps to be performed by the user. The following microservices are customer facing and are designed to be consumed by the Cold Climate UI.
- [Bayou Energy]()

To make these microservices available to the Cold Climate UI, you must add a `ui_options` block to the `definition` object in the microservice's `package.json` file.  This will allow the UI to discover the microservice and provide the user with the ability to configure it.
```package.json
"definition": {
    "rabbitMQ": {
      "rpcOptions": {
        "queue": "cold.platform.bayou",
        "routing_key": "cold.platform.bayou.rpc",
        "exchange": "amq.direct"
      },
      "publishOptions": {
        "queue": "cold.platform.bayou",
        "routing_key": "cold.platform.bayou",
        "exchange": "amq.direct"
      }
    },
    "ui_options": {
      "logo_url": "https://www.bayou.energy/img/logo_bayou.svg",
      "platform_url": "https://www.bayou.energy",
      "description": "Get Bayou’s API integrated in minutes for many utilities. And get your utility account connected in one click.",
      "helptext": "",
      "flags": {
        "embedable": false,
        "iframe_url_property": "onboarding_link",
        "iframe_url_token": "onboarding_token"
      }
    }
  } 
```

## Want better Editor Integration?

Have a look at the [Nx Console extensions](https://nx.dev/nx-console). It provides autocomplete support, a UI for exploring and running tasks & generators, and more! Available for VSCode, IntelliJ and comes with a LSP for Vim users.

## Ready to deploy?

Just run `nx build` to build the application. The build artifacts will be stored in the `dist/` directory, ready to be deployed.

## Set up CI!

Nx comes with local caching already built-in (check your `nx.json`). On CI you might want to go a step further.

- [Set up remote caching](https://nx.dev/core-features/share-your-cache)
- [Set up task distribution across multiple machines](https://nx.dev/core-features/distribute-task-execution)
- [Learn more how to setup CI](https://nx.dev/recipes/ci)

## Connect with NX!

- [Join the community](https://nx.dev/community)
- [Subscribe to the Nx Youtube Channel](https://www.youtube.com/@nxdevtools)
- [Follow us on Twitter](https://twitter.com/nxdevtools)

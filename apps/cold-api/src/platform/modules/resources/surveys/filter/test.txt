   '(\n' +
   ' $title := function($v){$v.title}; \n' +
   '         $section := function($k){$keys(sections)[$k]};      \n' +
   '         $total := function($v){$count($keys($v.follow_up))};         \n' +
   '         $answered := function($v){$count($filter($v.follow_up.*, function($q) { $exists($q.value) }))};      \n' +
   '         $complete := function($v){$total($v) = $answered($v)};     \n' +
   '         $questions := function($v){$merge($map($keys($v.follow_up), function($key) { {$key: {"user_answered": $exists($v.follow_up[$key].value) and $v.follow_up[$key].value != null, "ai_answered": $exists($v.follow_up[$key].ai_response.answer) and $v.follow_up[$key].ai_response.answer != null}}}))};  \n' +
   '         $createQuestions := function($v) {    \n' +
   '             $map($keys($v.follow_up), function($key, $v, $o)  \n' +   {
   '                  $createQuestionObject($v, $key, $o)      \n' +
   '             })                           \n' +
   '         };         \n' +
   '                                                         \n' +
   '         $createQuestionObject := function($idx, $key, $o) {    \n' +
   '             {                                                    \n' +
   '                 $key: {                                             \n' +
   '                     "max_score": $lookup(definition.sections.*.follow_up, $key).max_score,   \n' +
   '                     "score":$lookup(definition.sections.*.follow_up, $key).score,    \n' +
   '                     "user_answered": $exists($lookup(definition.sections.*.follow_up, $key).value),    \n' +
   '                     "ai_answered": $exists($lookup(definition.sections.*.follow_up, $key).ai_response.answer)   \n' +
   '                 }                 \n' +
   '             }                         \n' +
   '         };                           \n' +
   '                                             \n' +
   '         $mergeQuestions := function($v) {    \n' +
   '             $merge($createQuestions($v))   \n' +
   '         };                               \n' +
   '                                               \n' +
   '         $review := function($v){$count($v.follow_up[$k].ai_response.answer and $filter($v.follow_up.*, function($q) { $exists($q.value) }))};     \n' +
   '         $sectionScore := function($v){$sum($v.follow_up.*.score)};       \n' +
   '         $maxSectionScore := function($v){$sum($v.follow_up.*.max_score)};   \n' +
   '         $totalScore := $map(definition.sections.*, function($v, $k, $o) {   \n' +
   '                 $sum($v.follow_up.*.score)                  \n' +
   '             });                               \n' +
   '                                                \n' +
   '         $totalQuestionCount := function(){$count($keys(definition.sections.*.follow_up))};        \n' +
   '         $totalQuestionAnswered := function(){$count(definition.sections.*.follow_up.*.value)};    \n' +
   '                                                                                                \n' +
   '         $totalMaxScore := function(){$sum(definition.sections.*.follow_up.*.max_score)};      \n' +
   '                                                                                         \n' +
   '         {                                                                                 \n' +
   '             "total_score": $sum($totalScore),                                               \n' +
   '             "total_max_score": $sum($totalMaxScore()),                                       \n' +
   '             "question_count": $totalQuestionCount(),                                        \n' +
   '             "percentage": $sum($totalScore) / $sum($totalMaxScore()),                        \n' +
   '             "questions_answered": $totalQuestionAnswered(),                                  \n' +
   '             "sections":$map(definition.sections.*, function($v, $k, $o) {                    \n' +
   '             {                                                                                 \n' +
   '                   "section": $section($k),                                                     \n' +
   '                   "section_score": $sectionScore($v),                                          \n' +
   '                   "section_max_score": $maxSectionScore($v),                                    \n' +
   '                   "title": $title($v),                                                            \n' +
   '                   "total": $total($v),                                                          \n' +
   '                   "answered": $answered($v),                                                     \n' +
   '                   "complete": $complete($v),                                                     \n' +
   '                   "review": $count($keys($sift($mergeQuestions($v), function($v) { $v.user_answered = false and $v.ai_answered = true }))),     \n' +
   '                   "questions": $mergeQuestions($v)                                                    \n' +
   '             }                                                                     \n' +
   '         })                                                                  \n' +
   '         }                                                                    \n' +
   '
   ')'

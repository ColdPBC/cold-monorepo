<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://cold-public-assets.s3.us-east-2.amazonaws.com/Asset+4Logotype_Preferred.svg" width="699" alt="Cold Climate Logo" /></a>
</p>

  <p align="center">Monorepo for the Cold Climate Ecosystem</p>
    <p align="center"></p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description
✨ **This monorepo has been generated by [Nx, a Smart, fast and extensible build system.](https://nx.dev)** ✨
- /apps/cold-ui - The frontend application for the Cold Climate APP. This is a React application written in Typescript using the react framework.
- /apps/cold-api - The backend API for the Cold Climate APP written in Typescript using the Nest.js framework.

## Getting Started
- Make sure you've followed the instructions to set up your dev machine on [the Dev Setup Notion page](https://www.notion.so/coldclimate/Setting-Up-Your-Local-Environment-95c1f5398890412ab446d7ff94bcec7a?pvs=4), including Homebrew and Docker install
- install node 20.9.0:
  ```bash
    $ brew install node@20.9.0
  ```
- check yarn version 
    ```bash
    $ yarn -v
    ```
    if you receive an error like: ```zsh: command not found: yarn``` then you will need to install yarn globally
  - install latest yarn
    - install corepack globally
    ```bash
    $ yarn add global corepack
    ```
    - enable corepack
    ```bash
    $ corepack enable
    ```
    - set yarn version
    ```bash
    $ yarn set version latest
    ```
- install nestjs cli globally
  ```bash
  $ yarn add global @nestjs/cli 
  ````
- install prisma globally
  ```bash
  $ yarn add global prisma
  ```

### Environment Variables

Either create a .env file in the root directory of the project and populate the following variables. Or make sure they are stored in your IDE (Webstorm). You can get them from the Heroku staging server or ask Troy.

```dotenv
# General Settings
NODE_ENV=development
PORT=7001
API_SERVER_DESCRIPTION=The staging server is our development server
API_SERVER_URL=http://localhost:7001

# Auth0 Variables
AUTH0_AUDIENCE=https://api.coldclimate.online/
AUTH0_CLIENT_ID=UG9T########HQFI
AUTH0_CLIENT_SECRET=6r7D_6i########LoaIYb_
AUTH0_DOMAIN=cold-climate-staging.us.auth0.com
AUTH0_UI_CLIENT_ID=55HO8########SRWpG

# Database
DATABASE_URL="postgres://CC_admin:EPSILON-desti########y1d.us-east-1.rds.amazonaws.com/cold_climate"

# Redis Cache
REDISCLOUD_URL=redis://localhost:6379

```

### Install Node Dependencies

```bash
$ yarn
```

If you have trouble with the canvas package dependency on Apple silicon, you might need to build it from source. See [here](https://github.com/Automattic/node-canvas/).

### Generate Prisma Client
In order to make calls to the database, you will need to run the following command.

**NOTE**: you may receive a bunch of type errors if you do not run this command prior to building as this command generates the necessary types based on the DB schema.
```bash
$ prisma generate --schema apps/cold-api/prisma/schema.prisma
```
`prisma generate` will not only create the prisma client, but it will also generate the typescript types based on the schema, and place them in the `apps/cold-api/src/generated` directory.  The generated files will not conform to our linting rules, so you will need to also run `yarn lint` to fix the linting errors.

To run the prisma client generator and linting in one command, run the following:
```bash
$ yarn generate
```

### Running the APP locally
## Redis Server

This repo includes a `docker-compose.yml` file to help you easily run a local instance of `REDIS`.  This is necessary to run the API locally.

To start container just execute the following command

```bash
$  docker compose up
```
## API Server
To start the development API server run `nx serve cold-api`. Open your browser and navigate to http://localhost:7001/v1 to view the API docs.
```bash
$ nx serve cold-api
```

## UI Server
To start the development server run `nx serve cold-ui`. Open your browser and navigate to http://localhost:4200/
```bash
$ nx serve cold-ui
```

## API Documentation
### JSONata Expression Language

This API uses JSONata expressions to filter and transform data. Using the following JSON, we will demonstrate how to use JSONata expressions to filter and transform data.
```json
{
  "sections": {
    "APK": {
      "follow_up": {
        "APK-1": {
          "value": 50
        },
        "APK-2": {
          "value": 100
        }
      }
    },
    "GHG": {
      "follow_up": {
        "GHG-6": {
          "value": ["Yes we use GHG"]
        }
      }
    },
    "MFG": {
      "follow_up": {
        "MFG-1": {
          "value": true
        }
      }
    },
    "GEN": {
      "follow_up": {
        "GEN-8": {
          "value": ["Apparel", "Footwear", "Packs"]
        }
      }
    },
    "DWN": {
      "title": "Down",
      "prompt": "",
      "component": null,
      "follow_up": {
        "DWN-1": {
          "prompt": "Does your brand have a means of ensuring that the products you supply to REI that contain virgin down meet this expectation?"
        }
      }
    }
  }
}
```

#### Comparison Functions
*Compare Boolean Values*: You can use `=`, `!=`, to compare boolean values
```javascript
{
  dependency: {
    expression: "$lookup(sections.*.follow_up, 'MFG-1').value = true"
  }
}
```

*Compare Numeric Values* : You can use `=`, `!=`, `>`, `<`, `>=`, `<=` to compare numeric values
```javascript
{
  dependency: {
    expression: "$lookup(sections.*.follow_up, 'APK-1').value >= 50"
  }
}

```

#### Array Functions
*Compare Multiple Selected Values* : Using this expression you can check the selected values for the question are contained in the array of answers that satisfy the dependency
```javascript
{
  dependency: {
    expression: "true in $map($lookup(sections.*.follow_up, 'GEN-8').value, function($v) { $v in ['Apparel', 'Footwear', 'Packs', 'Ski wax', 'Sleeping bags', 'Tents', 'Treatments for gear and clothing'] })"
  }
}
// returns true
```

*Compare Single Selection* : If the both the selected value and the list of acceptable values are stored as a single value Array (ie: ['Yes we use GHG']) can either use the same function as above:
```javascript
{
  dependency: {
    expression: "true in $map($lookup(sections.*.follow_up, 'GHG-6').value, function($v) { $v in ['Yes, we calculate the carbon emissions from a subset of the products we sell, including those we sell to REI.'] })"
  }
}
// returns true
```

or you can simply compare arrays using the `=` operator
```javascript
{
  dependency: {
    expression: "$lookup(sections.*.follow_up, 'GHG-6').value = ['Yes, we calculate the carbon emissions from a subset of the products we sell, including those we sell to REI.'])"
  }
}
```

*Multiple Dependencies* : You can join expressions using `and` vs `or` to create more complex expressions

```javascript
{
  dependency: {
    expression: "$lookup(sections.*.follow_up, 'APK-1').value > 0 and $lookup(sections.*.follow_up, 'APK-2').value < 100"
  }
}
// returns false
```
```javascript
{
  dependency: {
    expression: "$lookup(sections.*.follow_up, 'APK-1').value > 0 and $lookup(sections.*.follow_up, 'APK-2').value <= 100"
  }
}
// returns true
```
```javascript
{
  dependency: {
    expression: "$lookup(sections.*.follow_up, 'APK-1').value > 0 or $lookup(sections.*.follow_up, 'APK-2').value < 100"
  }
}

//returns true
```

### View Swagger/OpenAPI Documentation

- Run the app using any of the above scripts
- Navigate to http://localhost:7001/v1 to view the Swagger/OpenAPI documentation.

### Importing the Postman Collection

- Open Postman
- Click on the Import button
- Click on the Link tab
- Paste the following URL into the input field: http://localhost:7001/v1-json
- Click on the Continue button

## Test

```bash
# unit tests
$ yarn test

# e2e tests
$ yarn test:e2e

# test coverage
$ yarn test:cov
```

## Running tasks

To execute tasks with Nx use the following syntax:

```
nx <target> <project> <...options>
```

You can also run multiple targets:

```
nx run-many -t <target1> <target2>
```

..or add `-p` to filter specific projects

```
nx run-many -t <target1> <target2> -p <proj1> <proj2>
```

Targets can be defined in the `package.json` or `projects.json`. Learn more [in the docs](https://nx.dev/core-features/run-tasks).

## Troubleshooting

### Errors During FlightControl/ AWS Code Build

### ENOMEM error when running `nx build cold-api`
When building the apps in FlightControl or CodeBuild, you may receive an ENOMEM error like in the log below:

```log
.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR Error: spawn ENOMEM
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at ChildProcess.spawn (node:internal/child_process:421:11)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at Object.spawn (node:child_process:761:9)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at ZY (/app/.yarn/releases/yarn-4.0.2.cjs:9:51927)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at RE.implementation (/app/.yarn/releases/yarn-4.0.2.cjs:159:1348)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at RE.exec (/app/.yarn/releases/yarn-4.0.2.cjs:165:1414)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at RE.run (/app/.yarn/releases/yarn-4.0.2.cjs:165:1585)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at ace (/app/.yarn/releases/yarn-4.0.2.cjs:165:7428)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at async Bot (/app/.yarn/releases/yarn-4.0.2.cjs:167:16)
5:56:12 PM #12 296.4 ➤ YN0000: │ contentlayer@npm:0.3.4 STDERR     at async u (/app/.yarn/releases/yarn-4.0.2.cjs:167:147)
5:56:12 PM #12 296.4 ➤ YN0009: │ contentlayer@npm:0.3.4 couldn't be built successfully (exit code 1, logs can be found here: /tmp/xfs-7e7d84e7/build.log)
```
In order to prevent this from happening, you need to increase the memory available to AWS CodeBuild.  To do this, 
- log into the AWS Console and navigate to CodeBuild.  
- Click on whichever project failed (ie: `cold-api-fc-vvac0727`) 
- Click on the `Edit` button.  
- Scroll down to the `Environment` section
- Click on the `Additional configuration` button.  
- In the `Additional configuration` section, increase the `Memory` to the next higher level.  
- Click on the `Update Project` button to save your changes.  

## Want better Editor Integration?

Have a look at the [Nx Console extensions](https://nx.dev/nx-console). It provides autocomplete support, a UI for exploring and running tasks & generators, and more! Available for VSCode, IntelliJ and comes with a LSP for Vim users.

## Ready to deploy?

Just run `nx build` to build the application. The build artifacts will be stored in the `dist/` directory, ready to be deployed.

## Set up CI!

Nx comes with local caching already built-in (check your `nx.json`). On CI you might want to go a step further.

- [Set up remote caching](https://nx.dev/core-features/share-your-cache)
- [Set up task distribution across multiple machines](https://nx.dev/core-features/distribute-task-execution)
- [Learn more how to setup CI](https://nx.dev/recipes/ci)

## Connect with NX!

- [Join the community](https://nx.dev/community)
- [Subscribe to the Nx Youtube Channel](https://www.youtube.com/@nxdevtools)
- [Follow us on Twitter](https://twitter.com/nxdevtools)

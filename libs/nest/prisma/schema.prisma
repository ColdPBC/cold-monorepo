generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["linux-arm64-openssl-1.1.x", "native"]
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../src/validation/generated"
  useMultipleFiles                 = "true"
  useDefaultValidators             = "false"
  createOptionalDefaultValuesTypes = "false"
  addInputTypeValidation           = "false"
  createInputTypes                 = "false"
  createPartialTypes               = "false"
  createModelTypes                 = "true"
  createRelationValuesTypes        = "false"
  addSelectType                    = "false"
  writeNullishInModelTypes         = "false"
  validateWhereUniqueInput         = "false"
  writeBarrelFiles                 = "false"
  coerceDate                       = "false"
  addIncludeType                   = "false"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// @namespace Actions
/// @erd action_templates
/// @erd actions
/// @describe Action Templates are a way to define a set of actions that can be taken by a user in the app.  Action Templates are then used to create Actions that are specific to an organization.
/// @zod.import(["import { ActionTemplateSchema } from '../../custom'"])
model action_templates {
  /// @zod.custom.use(z.string().uuid())
  id         String    @id @default(uuid())
  /// @zod.custom.use(ActionTemplateSchema)
  template   Json
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at DateTime  @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at DateTime  @default(now()) @updatedAt
  actions    actions[]
}

/// @namespace Actions
/// @erd organizations
/// @erd action_templates
/// @erd actions
/// @describe *Actions* are defined by an *Action Template* and are specific to an organization.
/// @zod.import(["import { ActionTemplateSchema } from '../../custom'"])
model actions {
  /// @zod.custom.use(z.string().uuid())
  id                 String           @id @default(uuid())
  /// @zod.custom.use(ActionTemplateSchema)
  action             Json
  /// @zod.custom.use(z.string().uuid())
  action_template_id String
  /// @zod.custom.use(z.string().uuid())
  organization_id    String
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at         DateTime         @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at         DateTime         @updatedAt
  action_template    action_templates @relation(fields: [action_template_id], references: [id], onDelete: Cascade)
  organization       organizations    @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

/// @namespace News
/// @describe News is a way to share climate information with users of the app.
model news {
  /// @zod.custom.use(z.string().uuid())
  id           String   @id @default(uuid())
  title        String
  /// @zod.custom.use(z.string().url())
  url          String
  /// @zod.custom.use(z.string().url())
  image_url    String
  published_at DateTime
  source_name  String
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at   DateTime @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at   DateTime @updatedAt
  publish      Boolean  @default(false)
}

/// @namespace Component Definitions
/// @describe Component definitions describe how a component should be rendered in the UI
model component_definitions {
  /// @DtoReadOnly
  /// #DtoHide
  /// @zod.custom.use(z.string().uuid())
  id          String                     @id @default(uuid())
  name        String                     @unique
  type        component_definition_types
  /// @zod.custom.use(z.string())
  description String
  definition  Json
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at  DateTime                   @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at  DateTime                   @updatedAt
}

/// @namespace Policies
/// @describe Policy Definitions are a set of content policies (ie: Privacy & ToS)
/// @erd policy_data
model policy_definitions {
  /// @zod.custom.use(z.number().int().positive())
  id          Int           @id @default(autoincrement())
  name        String
  definition  String
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at  DateTime      @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at  DateTime      @updatedAt
  policy_data policy_data[]
}

/// @namespace Policies
/// @describe Policy Definitions are a set of content policies (ie: Privacy & ToS)
/// @erd policy_definitions
model policy_data {
  /// @zod.custom.use(z.string().email())
  email             String
  /// @zod.custom.use(z.number().int().positive())
  id                Int
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at        DateTime           @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at        DateTime           @updatedAt
  policy_definition policy_definitions @relation(fields: [id], references: [id], onDelete: Cascade)

  @@unique([email, id])
}

/// @namespace Surveys
/// @erd survey_data
/// @erd organizations
/// @zod.import(["import { SurveyDefinitionSchema } from '../../custom'"])
model survey_definitions {
  /// @zod.custom.use(z.string().uuid())
  id          String        @id @default(uuid())
  name        String        @unique
  /// @z.enum()
  type        survey_types
  description String
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at  DateTime      @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at  DateTime      @updatedAt
  /// @zod.custom.use(SurveyDefinitionSchema)
  definition  Json
  survey_data survey_data[]
}

/// @namespace Surveys
/// @erd organizations
/// @zod.import(["import { SurveyDefinitionSchema } from '../../custom'"])
model survey_data {
  /// @zod.custom.use(z.string().uuid())
  id                   String             @id @unique @default(uuid())
  /// @zod.custom.use(z.string().uuid())
  organization_id      String
  /// @zod.custom.use(SurveyDefinitionSchema.optional())
  data                 Json
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at           DateTime           @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at           DateTime           @updatedAt
  /// @zod.custom.use(z.string().uuid())
  survey_definition_id String
  organizations        organizations      @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  survey_definition    survey_definitions @relation(fields: [survey_definition_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, survey_definition_id], name: "orgSurveyKey")
}

/// @namespace Categories
/// @erd category_data
/// @erd organizations
/// @zod.import(["import { CategoryDefinitionSchema } from '../../custom'"])
model category_definitions {
  /// @zod.custom.use(z.string().uuid())
  id            String          @id @default(uuid())
  name          String          @unique
  description   String
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at    DateTime        @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at    DateTime        @updatedAt
  /// @zod.custom.use(CategoryDefinitionSchema)
  definition    Json
  category_data category_data[]
}

/// @namespace Categories
/// @erd category_definitions
/// @erd organizations
/// @zod.import(["import { CategoryDefinitionSchema } from '../../custom'"])
model category_data {
  id                     String               @id @unique @default(uuid())
  /// @zod.custom.use(z.string().uuid())
  category_definition_id String
  /// @zod.custom.use(z.string().uuid())
  organization_id        String
  /// @zod.custom.use(CategoryDefinitionSchema.optional())
  data                   Json
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at             DateTime             @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at             DateTime             @updatedAt
  category_definition    category_definitions @relation(fields: [category_definition_id], references: [id], onDelete: Cascade)
  organizations          organizations        @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

/// @namespace Organizations
/// @erd organization_facilities
/// @erd survey_data
/// @zod.import(["import { organization_facilitiesSchema } from '../../custom'"])
/// @actions
model organizations {
  /// @zod.custom.use(z.string().uuid())
  id                       String                     @id
  name                     String                     @unique
  enabled_connections      Json
  display_name             String
  branding                 Json?
  phone                    String?
  /// @zod.custom.use(z.string().email())
  email                    String?
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at               DateTime                   @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at               DateTime                   @updatedAt
  isTest                   Boolean                    @default(false)
  actions                  actions[]
  category_data            category_data[]
  integrations             integrations[]
  organization_compliances organization_compliances[]
  organization_files       organization_files[]
  facilities               organization_facilities[]
  survey_data              survey_data[]
  utility_bills            utility_bills[]
}

/// @namespace Organization_Facilities
/// @erd utility_bills
/// @erd integrations
/// @erd emissions
/// @erd organizations
/// @zod.import(["import { organization_facilitiesSchema } from '../../custom'"])
/// @actions
model organization_facilities {
  id              String          @id @default(cuid())
  organization_id String
  name            String?
  address         String
  city            String
  state           String
  country         String          @default("US")
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt
  address_line_2  String?
  postal_code     String
  emissions       emissions[]
  integrations    integrations[]
  organizations   organizations   @relation(fields: [organization_id], references: [id])
  utility_bills   utility_bills[]
}

model service_definitions {
  id                  String                   @id @default(uuid())
  name                String                   @unique
  label               String
  definition          Json
  created_at          DateTime                 @default(now())
  updated_at          DateTime                 @updatedAt
  type                integration_service_type
  integrations        integrations[]
  supported_utilities supported_utilities[]
}

/// @namespace Integrations
/// @describe Integrations are a way to connect to external services
/// @erd integrations
model integrations {
  /// @zod.custom.use(z.string().uuid())
  id                    String                   @id @default(uuid())
  service_definition_id String
  /// @zod.custom.use(z.string().uuid())
  organization_id       String
  metadata              Json
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at            DateTime                 @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at            DateTime                 @updatedAt
  location_id           String?
  emissions             emissions[]
  location              organization_facilities? @relation(fields: [location_id], references: [id], onDelete: Cascade)
  organization          organizations            @relation(fields: [organization_id], references: [id])
  service_definition    service_definitions      @relation(fields: [service_definition_id], references: [id], onDelete: Cascade)
  files                 organization_files[]
  unility_bills         utility_bills[]

  @@unique([service_definition_id, location_id], name: "integrationKey")
}

/// @namespace Supported Utilities
/// @describe List of supported utilities for a given service definition
/// @erd supported_utilities
model supported_utilities {
  /// @zod.custom.use(z.string().cuid())
  id                    String              @id @unique @default(cuid())
  /// @zod.custom.use(z.string().uuid())
  service_definition_id String
  /// @zod.custom.use(z.string())
  name                  String              @unique
  /// @zod.custom.use(z.string())
  label                 String
  data                  Json
  /// @DtoUpdateHidden
  /// @zod.custom.use(z.date().optional())
  created_at            DateTime            @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at            DateTime            @updatedAt
  service_definition    service_definitions @relation(fields: [service_definition_id], references: [id], onDelete: Cascade)
}

/// @namespace Emissions
/// @describe List of emissions for a given organization
/// @erd emissions
model emissions {
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.string().uuid())
  id                      String                  @id @default(uuid())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  created_at              DateTime                @default(now())
  /// @DtoUpdateHidden
  /// @DtoCreateHidden
  /// @DtoReadOnly
  /// @zod.custom.use(z.date().optional())
  updated_at              DateTime                @updatedAt
  integration_id          String
  activity_data           Json
  integration_data        Json
  name                    String
  region                  String
  category                String
  co2e                    Float
  co2e_calculation_origin String
  co2e_unit               String
  emission_factor         Json
  location_id             String
  co2_calculation_method  String
  constituent_gases       Json
  integrations            integrations            @relation(fields: [integration_id], references: [id], onDelete: Cascade)
  location                organization_facilities @relation(fields: [location_id], references: [id], onDelete: Cascade)
}

/// @namespace Utility Bills
/// @describe List of utility bills for a given organization and integration
/// @erd emissions
model utility_bills {
  id              String                  @id @default(cuid())
  integration_id  String
  period_from     DateTime
  period_to       DateTime
  data            Json
  created_at      DateTime                @default(now())
  updated_at      DateTime                @updatedAt
  location_id     String
  organization_id String
  integration     integrations            @relation(fields: [integration_id], references: [id], onDelete: Cascade)
  location        organization_facilities @relation(fields: [location_id], references: [id], onDelete: Cascade)
  organization    organizations           @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

model organization_files {
  bucket              String?
  key                 String?
  original_name       String
  organization_id     String
  openai_assistant_id String?
  openai_file_id      String?       @unique
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  id                  String        @id @default(cuid())
  integration_id      String?
  mimetype            String?
  size                Int?
  acl                 String?
  contentType         String?
  encoding            String?
  fieldname           String?
  location            String?
  versionId           String?
  checksum            String?
  integration         integrations? @relation(fields: [integration_id], references: [id], onDelete: Cascade)
  organization        organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, id], name: "orgFileId")
  @@unique([organization_id, openai_file_id], name: "openaiFileId")
  @@unique([organization_id, bucket, key], name: "s3Key")
}

model compliance_definitions {
  id                       String                     @id @default(cuid())
  name                     String                     @unique
  logo_url                 String
  surveys                  Json
  created_at               DateTime                   @default(now())
  updated_at               DateTime                   @updatedAt
  title                    String
  organization_compliances organization_compliances[]
}

model organization_compliances {
  id                    String                 @id @default(cuid())
  organization_id       String
  compliance_id         String
  created_at            DateTime               @default(now())
  updated_at            DateTime               @updatedAt
  compliance_definition compliance_definitions @relation(fields: [compliance_id], references: [id], onDelete: Cascade)
  organization          organizations          @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, compliance_id], name: "orgKeyCompKey")
}

enum integration_service_type {
  provider
  platform
  core
}

enum survey_types {
  JOURNEY
  FOOTPRINT
  ENRICHMENT
  SOLUTION
  TEST
  COMPLIANCE
}

enum component_definition_types {
  UNKNOWN
  FORM
  NAVIGATION_SIDE
  NAVIGATION_HEADER
  NAVIGATION_FOOTER
  DATAGRID
  TEST
}

enum emissions_categories {
  ELECTRICITY
  FUEL
  WASTE
  WATER
  TRANSPORTATION
  OTHER
  TEST
  NATURAL_GAS
}

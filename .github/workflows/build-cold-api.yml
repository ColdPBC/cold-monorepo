name: 'Pre-Build'
on:
  workflow_dispatch:
  push:
    branches:
      - 'cold-**'
      - 'COLD-**'
      - 'Cold-**'
  pull_request:
    branches:
      - staging
      - main
env:
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  NPM_TOKEN: ${{ secrets.GH_TOKEN }}
  CACHE_NAME: cache-node-modules
  PR_NUMBER: ${{ github.event.number }}
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
jobs:
  build:
    name: ğŸ’¼ Dependencies / ğŸ·ï¸ Versioning
    runs-on: ubuntu-latest

    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: âš™ Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: âš™ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9.0"
      - name: ğŸ’¼ Cache node modules
        uses: actions/cache@v3
        with:
          path: ./node_modules
          key: ${{ runner.os }}-build-${{ env.CACHE_NAME }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.CACHE_NAME }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      #Database Migrations
      - name: ğŸ§¶ Install yarn
        run: corepack enable && yarn set version stable
      - name: ğŸ§© Install dependencies
        continue-on-error: true
        run: yarn install && yarn postinstall
      - name: ğŸ­ Generate Prisma Client
        run: yarn dlx nx run coldpbc/nest:prisma-generate

      - name: ğŸŒ± Get Next Version
        run: npx -p semantic-release -p @semantic-release/changelog -p @semantic-release/commit-analyzer -p @semantic-release/git -p @semantic-release/npm -p @semantic-release/release-notes-generator semantic-release

      - name: ğŸ“‚ Update FlightControl
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
          GIT_TERMINAL_PROMPT: 0
        run: |
         yarn setVersion /
         git config --local user.name github-actions /
         git config --local user.email <> /
         git add . /

      - name: ğŸ·ï¸ Commit
        run: |
          git commit -m "ci: update flightcontrol.json [skip actions] [skip ci]"

      - name: ğŸšš Push Changes To GitHub
        uses: CasperWA/push-protected@v2
        with:
           token: ${{ secrets.GH_TOKEN }}
           branch: ${{ env.BRANCH_NAME }}
           unprotect_reviews: true
           force: true
           timeout: 3
           acceptable_conclusions: success, failure, neutral, cancelled, skipped, timed_out, action_required

      - name: ğŸ Done!
        run: |
          echo "âœ… Dependencies & Version Complete: ğŸŒ± $(npm pkg get version) ğŸŒ±"

  deploy:
    name: ğŸ›©ï¸ Trigger Deploy
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - name: ğŸš€ Set prod version in heroku
        run: |
          curl --request PATCH \
          --url 'https://api.heroku.com/apps/api-cold-climate-production/config-vars' \
          --header 'Accept: application/vnd.heroku+json; version=3`.\n' \
          --header 'Content-Type: application/json' \
          --header 'Authorization: Bearer ${{secrets.HEROKU_API_KEY}}' \
          --data "{\"DD_VERSION\":$(npm pkg get version)}"

      - name: ğŸš€ Set Staging Version in Heroku
        if: startsWith(env.BRANCH_NAME,'staging') || startsWith(env.BRANCH_NAME,'cold') || startsWith(env.BRANCH_NAME,'Cold') || startsWith(env.BRANCH_NAME,'COLD')
        run: |
          curl --request PATCH \
          --url 'https://api.heroku.com/apps/api-cold-climate-staging/config-vars' \
          --header 'Accept: application/vnd.heroku+json; version=3`.\n' \
          --header 'Content-Type: application/json' \
          --header 'Authorization: Bearer ${{secrets.HEROKU_API_KEY}}' \
          --data "{\"DD_VERSION\":$(npm pkg get version)}"

      - name: ğŸ›©ï¸ Trigger Production Deploy
        if: startsWith(env.BRANCH_NAME,'main')
        run: |
          curl -n -X POST https://app.flightcontrol.dev/api/deploy-hook/cold-production/wKyB691SxArA4LuDb3FDaptLaexm8Vtv2DAc_2w6gw-_WOYH?force=false
          echo "ğŸ›© Flightcontrol Deploying ( https://app.flightcontrol.dev/org/cloejv4kz05s0ps21f3q2qjxe/environments/clpgmjfpl049fr90yqwdsuqd8 )"

      - name: ğŸ›©ï¸ Trigger Staging Deploy
        if: startsWith(env.BRANCH_NAME,'staging')
        run: |
          curl -n -X POST https://app.flightcontrol.dev/api/deploy-hook/cold-staging/58vWGjvmj9PWGxzImyRkVCTujxuJT-Q8piPwciMogtAy4-ci?force=false
          echo "ğŸ›© Flightcontrol Deploying ( https://app.flightcontrol.dev/org/cloejv4kz05s0ps21f3q2qjxe/environments/clpeertbx01sgpx0yy5cu4imq )"

      - name: ğŸ›©ï¸ Trigger Preview Deploy
        if: ${{ github.event.number }} && (startsWith(env.BRANCH_NAME,'cold') || startsWith(env.BRANCH_NAME,'Cold') || startsWith(env.BRANCH_NAME,'COLD'))
        run: |
          curl -n -X POST https://app.flightcontrol.dev/api/deploy-hook/cold-preview/xaQAJM9Iw4G6UWmYTX0RLYdU1krFiPnKNV-lzQeTc6crqjgc/${{ github.event.number }}/$(git rev-parse --short "$GITHUB_SHA")?force=false
          echo "ğŸ›© Flightcontrol Deploying ( https://app.flightcontrol.dev/org/cloejv4kz05s0ps21f3q2qjxe/projects/clpeerpk90034r71b0tiky5vd/preview-environments )"

      - name: ğŸ Done!
        run: echo "ğŸ›© Flightcontrol Deploying ğŸ›©"
